name: Build macOS app for release

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-latest
            arch: x86_64
          - runner: macos-latest
            arch: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: 18
          cache: pnpm
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build Tauri app bundle
        run: pnpm tauri build --bundles dmg
      - name: Upload macOS app artifact
        uses: actions/upload-artifact@v4
        with:
          name: kami-macos-app-${{ matrix.arch }}
          path: src-tauri/target/release/bundle/dmg/kami*.dmg
          if-no-files-found: error
      - name: Write workflow summary
        run: |
          {
            echo "### macOS app artifact"
            echo ""
            echo "- name: kami-macos-app-${{ matrix.arch }}"
            echo "- path: src-tauri/target/release/bundle/dmg/kami*.dmg"
            echo "- runner: ${{ matrix.runner }}"
          } >> "$GITHUB_STEP_SUMMARY"
